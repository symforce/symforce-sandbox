#!/usr/bin/env php
<?php

	$dir	= dirname(__DIR__);
	chdir( $dir );
        
	$longopts  = array(
		'env:' ,
		'user::' , 
		'group::' ,
		'admin' ,
        'assetic' ,
		'verbose' ,
	);
	$options = getopt('e:u::g::x::v::a', $longopts);
	$getarg	= function($s, $l, $v = null, $match = null , $error = null ) use($options) {
		if( isset($options[$s] ) ) $v = $options[$s] ;
		else if( isset($options[$l] ) ) $v = $options[$l] ;
		if( $match && !preg_match( $match, $v ) ) {
			$msg	= sprintf( $error, $v);
			echo $msg, "\n";
			exit;
		} else if( false === $v ) {
                    $v  = true ;
                }
		return $v ;
	};
    $web_user   = null ;
    $web_group  = null ;
    $web_assets_dir = null ;
    $read_user_group   = function( & $var , $match ) use ( $dir ){
         if( null !== $var ) return ;
         $files = array( $dir . '/app/config/parameters.yml' , $dir . '/app/config/parameters.yml.dist' ) ;
         foreach($files as $file ) {
             if( file_exists($file) ) {
                $data  = file_get_contents($file) ;
                preg_match('/sf\.web_' . $match . ':\s*(.+)\s/', $data, $ls);
                if( $ls && isset($ls[1]) ) {
                    $var    =  $ls[1] ;
                    break ;
                }
             }
         }
    };
    $read_user_group( $web_user , 'user' );
    $read_user_group( $web_group , 'group' );
    $read_user_group( $web_assets_dir , 'assets_dir' );
    if( !$web_user ) $web_user  = 'www-data' ;
    if( !$web_group ) $web_group  = 'www-data' ;
    if( !$web_assets_dir ) $web_assets_dir  = '/assets' ;
        
	$env	= $getarg('e', 'env', 'dev', '/^(prod|dev|test)$/',  'env:`%s` must be one of (dev, prod, test)' );
	$user   = $getarg('u', 'user', $web_user , '/^[\w\-\_]+$/',  'user:`%s` is valid' );
	$group	= $getarg('g', 'group', $web_group, '/^[\w\-\_]+$/',  'group:`%s` is valid');
	$app	= $getarg('x', 'admin' );
    $assetic    = $getarg('a', 'assetic' ) ;
	$verbose    = $getarg('v', 'verbose' ) ? '-v': '' ;

    $is_dev = 'dev' === $env ;
        
    $exec   = function($cmd){
            echo ">>>: ", $cmd, "\n" ;
            passthru($cmd) ;
    };
        
	$exec("rm -rf app/cache/$env/profiler");
	
    if( $assetic || !$is_dev ) {
        $file   = $dir . '/app/config/parameters.yml' ;
        if( file_exists($file) ) {
            $data  = file_get_contents($file) ;
            $_data  = preg_replace_callback('/(\s+app\.version\s*\:).*/', function($ms){
                return $ms[1] . date(' YmdHis') ;
            } , $data) ;
            file_put_contents($file, $_data);
        }
        $exec("rm -rf app/cache/$env/*.* app/cache/$env/assetic") ;
    }

    if( !$is_dev ) {
        $exec("rm -rf app/cache/$env/annotations app/cache/$env/doctrine app/cache/$env/profiler app/cache/$env/translations app/cache/$env/twig") ;
        $exec("rm -rf app/Resources/views/* app/Resources/SymforceAdminCache/*") ;
    }

    if( $assetic || !$is_dev ) {
        $exec("rm -rf web{$web_assets_dir}");
    }

    if( $app || !$is_dev ) {
        $exec("rm -rf app/cache/$env/SymforceLoader*") ;
	}

    if( !$is_dev ) {
        $exec("./app/console debug:router --env=$env " . $verbose) ;
        $exec("./app/console cache:warmup --env=$env " . $verbose);
        $exec("./app/console assetic:dump --env=$env --no-debug " . $verbose);
    }

    $exec("./app/console sf:admin:setup --env=$env " . $verbose);

    $exec("chown -R $user:$group app/ bin/ src/ web/ composer.*");

    // composer.phar update --dev --prefer-dist -vvv
    // composer.phar dumpautoload -o
    // ./app/console sf:admin:dump --watch --no-dump-main --force -vvv
